<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ConferÃªncia de Paletes por Ãrea</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* (seu CSS original â€“ mantido) */
.ajuda-box {
  background: #fff3cd;
  border: 1px solid #ffeeba;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  display: none;
}
.ajuda-box h3 { margin-top: 0; color: #856404; }
.btn-ajuda { background: #ffc107; color: #000; margin-left: 10px; }
body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
h2 { color: #d32f2f; }
.area {
  background: #fff;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,.1);
}
.area-header { display: flex; gap: 10px; margin-bottom: 10px; }
.area-header input { padding: 6px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
button {
  padding: 6px 12px;
  cursor: pointer;
  border: none;
  background: #1976d2;
  color: white;
  border-radius: 4px;
}
button:hover { opacity: 0.85; }
.resumo {
  background: #fff;
  padding: 15px;
  border-radius: 8px;
  margin-top: 20px;
}
</style>
</head>

<body>

<h2>ğŸ“¦ ConferÃªncia de Paletes por Ãrea</h2>

<button class="btn-ajuda" onclick="toggleAjuda()">â“ Ajuda</button>

<div id="ajuda" class="ajuda-box">
  <h3>ğŸ“˜ Como usar</h3>
  <ol>
    <li>Adicione a Ã¡rea (ex: A01)</li>
    <li>Informe os SKUs e paletes que EXISTEM fisicamente</li>
    <li>Os valores irÃ£o SOBREPÃ”R o estoque anterior</li>
    <li>Use esta tela apenas para conferÃªncia</li>
  </ol>
</div>

<button onclick="adicionarArea()">â• Adicionar Ãrea</button>
<button onclick="salvarNoBanco()">ğŸ’¾ Confirmar ConferÃªncia</button>

<div id="areas"></div>

<div class="resumo">
  <h3>ğŸ“Š Resumo</h3>
  <div id="resumo"></div>
  <button onclick="exportarExcel()">ğŸ“¥ Exportar Excel</button>
</div>

<script>
// ğŸ” CONFIGURAÃ‡ÃƒO SUPABASE
const supabase = supabase.createClient(
  'SUA_SUPABASE_URL',
  'SUA_SUPABASE_ANON_KEY'
)

// UI
function toggleAjuda() {
  const ajuda = document.getElementById('ajuda')
  ajuda.style.display = ajuda.style.display === 'none' ? 'block' : 'none'
}

let areas = []

function adicionarArea() {
  areas.push({ nome:'', capacidade:0, itens:[] })
  render()
}

function adicionarItem(areaIndex) {
  areas[areaIndex].itens.push({ sku:'', qtd:0 })
  render()
}

function atualizar(areaIndex, tipo, itemIndex, campo, valor) {
  if (tipo === 'area') areas[areaIndex][campo] = valor
  else areas[areaIndex].itens[itemIndex][campo] = valor
  renderResumo()
}

function render() {
  const div = document.getElementById('areas')
  div.innerHTML = ''

  areas.forEach((area, aIdx) => {
    const totalArea = area.itens.reduce((s,i)=>s+Number(i.qtd||0),0)

    div.innerHTML += `
      <div class="area">
        <div class="area-header">
          <input placeholder="Ãrea (A01)"
            onchange="atualizar(${aIdx},'area',0,'nome',this.value)">
          <input type="number" placeholder="Capacidade"
            onchange="atualizar(${aIdx},'area',0,'capacidade',this.value)">
          <b>${totalArea}/${area.capacidade || 0}</b>
        </div>

        <table>
          <tr><th>SKU</th><th>Paletes</th></tr>
          ${area.itens.map((i,iIdx)=>`
            <tr>
              <td><input onchange="atualizar(${aIdx},'item',${iIdx},'sku',this.value)"></td>
              <td><input type="number" onchange="atualizar(${aIdx},'item',${iIdx},'qtd',this.value)"></td>
            </tr>
          `).join('')}
        </table>

        <button onclick="adicionarItem(${aIdx})">â• Adicionar SKU</button>
      </div>
    `
  })

  renderResumo()
}

function renderResumo() {
  let total = 0
  let porSku = {}

  areas.forEach(a=>{
    a.itens.forEach(i=>{
      total += Number(i.qtd||0)
      porSku[i.sku] = (porSku[i.sku]||0) + Number(i.qtd||0)
    })
  })

  let html = `<b>Total Geral:</b> ${total} paletes<br><br>`
  html += `<table><tr><th>SKU</th><th>Total</th></tr>`
  for (let sku in porSku) {
    html += `<tr><td>${sku}</td><td>${porSku[sku]}</td></tr>`
  }
  html += `</table>`

  document.getElementById('resumo').innerHTML = html
}

// ğŸ’¾ SALVAR NO BANCO (UPSERT)
async function salvarNoBanco() {
  let registros = []

  areas.forEach(area=>{
    area.itens.forEach(i=>{
      registros.push({
        area: area.nome,
        sku: i.sku,
        paletes: Number(i.qtd)
      })
    })
  })

  const { error } = await supabase
    .from('estoque_area')
    .upsert(registros)

  if (error) {
    alert('Erro ao salvar')
    console.error(error)
  } else {
    alert('ConferÃªncia salva com sucesso')
  }
}

// ğŸ“¥ EXCEL
function exportarExcel() {
  let linhas = [['Ãrea','SKU','Paletes']]
  areas.forEach(a=>{
    a.itens.forEach(i=>{
      linhas.push([a.nome, i.sku, i.qtd])
    })
  })
  const wb = XLSX.utils.book_new()
  const ws = XLSX.utils.aoa_to_sheet(linhas)
  XLSX.utils.book_append_sheet(wb, ws, 'ConferÃªncia')
  XLSX.writeFile(wb, 'Conferencia_Estoque.xlsx')
}
</script>

</body>
</html>
